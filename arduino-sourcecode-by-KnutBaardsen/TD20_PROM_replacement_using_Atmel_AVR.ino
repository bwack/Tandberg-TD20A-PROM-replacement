// Replacement for the TD20A PROM. 
// Circuit in use is an Atmel AVR Mega328, but can be adapted for any MCU with 16 free I/O lines.
// Written by Knut Baardsen September 2016 (knut@baso.no)
// Can be freely used and changed, but not for commercial usage!

byte data_in;
byte data_out;

// Data for 7.5 IPS (PINK color marking)
byte td20_75[256] = {
  0b10000110,0b10000110,0b10100110,0b11000101,0b10100110,0b10100010,0b10100001,0b11100001,
  0b10101110,0b10101010,0b10101001,0b11101001,0b10110110,0b10110010,0b10110001,0b11110001,
  0b11100101,0b10100101,0b11100110,0b10101101,0b10100111,0b10100001,0b10100001,0b10100001,
  0b10100111,0b10100001,0b10100001,0b10100001,0b10111111,0b10100101,0b10100101,0b10101101,
  0b10011110,0b11011111,0b10011110,0b11000101,0b10100110,0b11100011,0b10100001,0b11100001,
  0b10101110,0b11101011,0b10101001,0b11101001,0b10110110,0b11110011,0b10110001,0b11110001,
  0b11101101,0b10101101,0b01101111,0b10101110,0b10100111,0b10100001,0b10100001,0b10100001,
  0b10100111,0b10100001,0b10100001,0b10100001,0b11100110,0b10100101,0b11100110,0b10101101,
  0b10000110,0b10000110,0b10100110,0b11000101,0b10100110,0b10100010,0b10100001,0b11100001,
  0b10101110,0b10101010,0b10101001,0b11101001,0b10110110,0b10110010,0b10110001,0b11110001,
  0b11100101,0b10100101,0b11100110,0b10101101,0b10100111,0b10100001,0b10100001,0b10100001,
  0b10100111,0b10100001,0b10100001,0b10100001,0b10111111,0b10100101,0b10100101,0b10101101,
  0b10011110,0b11011111,0b10011110,0b11000101,0b10100110,0b11100011,0b10100001,0b11100001,
  0b10101110,0b11101011,0b10101001,0b11101001,0b10110110,0b11110011,0b10110001,0b11110001,
  0b11101101,0b10101101,0b01101111,0b10101110,0b10100111,0b10100001,0b10100001,0b10100001,
  0b10100111,0b10100001,0b10100001,0b10100001,0b11100110,0b10100101,0b11100110,0b10101101,
  0b10011110,0b10011110,0b10111110,0b11011101,0b10100010,0b10100010,0b10100001,0b11100001,
  0b10101010,0b10101010,0b10101001,0b11101001,0b10110010,0b10110010,0b10110001,0b11110001,
  0b11100101,0b10100101,0b11100110,0b10101101,0b10100011,0b10100001,0b10100001,0b10100001,
  0b10100011,0b10100001,0b10100001,0b10100001,0b10111111,0b10110101,0b10100101,0b10101101,
  0b10011110,0b11011111,0b10011101,0b11011101,0b10100010,0b11100011,0b10100001,0b11100001,
  0b10101010,0b11101011,0b10101001,0b11101001,0b10110010,0b11110011,0b10110001,0b11110001,
  0b11100101,0b10101101,0b01101111,0b10101110,0b10100011,0b10100001,0b10100001,0b10100001,
  0b10100011,0b10100001,0b10100001,0b10100001,0b11100110,0b10110101,0b11100110,0b10101101,
  0b10011110,0b10011110,0b10111110,0b11011101,0b10100010,0b10100010,0b10100001,0b11100001,
  0b10101010,0b10101010,0b10101001,0b11101001,0b10110010,0b10110010,0b10110001,0b11110001,
  0b11100101,0b10100101,0b11100110,0b10101101,0b10100011,0b10100001,0b10100001,0b10100001,
  0b10100011,0b10100001,0b10100001,0b10100001,0b10111111,0b10110101,0b10100101,0b10101101,
  0b10011110,0b11011111,0b10011101,0b11011101,0b10100010,0b11100011,0b10100001,0b11100001,
  0b10101010,0b11101011,0b10101001,0b11101001,0b10110010,0b11110011,0b10110001,0b11110001,
  0b11100101,0b10101101,0b01101111,0b10101110,0b10100011,0b10100001,0b10100001,0b10100001,
  0b10100011,0b10100001,0b10100001,0b10100001,0b11100110,0b10110101,0b11100110,0b10101101 
};

// Data for 15 IPS (ORANGE color marking)
byte td20_15[256] = {
  0b10000110,0b10000110,0b10100110,0b11000101,0b10100110,0b10100010,0b10100001,0b11100001,
  0b10101110,0b10101010,0b10101001,0b11101001,0b10110110,0b10110010,0b10110001,0b11110001,
  0b11100101,0b10100101,0b11100110,0b10101101,0b10100111,0b10100001,0b10100001,0b10100001,
  0b10100111,0b10100001,0b10100001,0b10100001,0b10111111,0b10100101,0b10100101,0b10101101,
  0b10011110,0b11011111,0b10011110,0b11000101,0b10100110,0b11100011,0b10100001,0b11100001,
  0b10101110,0b11101011,0b10101001,0b11101001,0b10110110,0b11110011,0b10110001,0b11110001,
  0b11101101,0b10101101,0b01101111,0b10101110,0b10100111,0b10100001,0b10100001,0b10100001,
  0b10100111,0b10100001,0b10100001,0b10100001,0b11100110,0b10100101,0b11100110,0b10101101,
  0b10000110,0b10000110,0b10100110,0b11000101,0b10100110,0b10100010,0b10100001,0b11100001,
  0b10101110,0b10101010,0b10101001,0b11101001,0b10110110,0b10110010,0b10110001,0b11110001,
  0b11100101,0b10100101,0b11100110,0b10101101,0b10100111,0b10100001,0b10100001,0b10100001,
  0b10100111,0b10100001,0b10100001,0b10100001,0b10111111,0b10100101,0b10100101,0b10101101,
  0b10011110,0b11011111,0b10011110,0b11000101,0b10100110,0b11100011,0b10100001,0b11100001,
  0b10101110,0b11101011,0b10101001,0b11101001,0b10110110,0b11110011,0b10110001,0b11110001,
  0b11101101,0b10101101,0b01101111,0b10101110,0b10100111,0b10100001,0b10100001,0b10100001,
  0b10100111,0b10100001,0b10100001,0b10100001,0b11100110,0b10100101,0b11100110,0b10101101,
  0b10011110,0b10011110,0b10111110,0b11011101,0b10100010,0b10100010,0b10100001,0b11100001,
  0b10101010,0b10101010,0b10101001,0b11101001,0b10110010,0b10110010,0b10110001,0b11110001,
  0b11100101,0b10100101,0b11100110,0b10101101,0b10100011,0b10100001,0b10100001,0b10100001,
  0b10100011,0b10100001,0b10100001,0b10100001,0b10111111,0b10110101,0b10100101,0b10101101,
  0b10011110,0b11011111,0b10011101,0b11011101,0b10100010,0b11100011,0b10100001,0b11100001,
  0b10101010,0b11101011,0b10101001,0b11101001,0b10110010,0b11110011,0b10110001,0b11110001,
  0b11100101,0b10101101,0b01101111,0b10101110,0b10100011,0b10100001,0b10100001,0b10100001,
  0b10100011,0b10100001,0b10100001,0b10100001,0b11100110,0b10110101,0b11100110,0b10101101,
  0b10011010,0b10011010,0b10111010,0b11011001,0b10100010,0b10100010,0b10100001,0b11100001,
  0b10101010,0b10101010,0b10101001,0b11101001,0b10110010,0b10110010,0b10110001,0b11110001,
  0b11111001,0b10111001,0b11111010,0b10111001,0b10100011,0b10100001,0b10100001,0b10100001,
  0b10100011,0b10100001,0b10100001,0b10100001,0b10111011,0b10110101,0b10100101,0b10101101,
  0b10011010,0b11011011,0b10011010,0b11011001,0b10100010,0b11100011,0b10100001,0b11100001,
  0b10101010,0b11101011,0b10101001,0b11101001,0b10110010,0b11110011,0b10110001,0b11110001,
  0b11101001,0b10111001,0b01101111,0b10111010,0b10100011,0b10100001,0b10100001,0b10100001,
  0b10100011,0b10100001,0b10100001,0b10100001,0b11100110,0b10110101,0b11100110,0b10101101 
};


void setup() {
  // Input is built up as (D7,D6,D5,D4,D3,D2,B1,B0) (MSB,LSB)
  // Output is built up as (C3,C2,C1,C0,B5,B4,B3,B2) (MSB,LSB)
  DDRB = 0x7C;
  DDRC = 0x0F;
}


void loop() {
  // Read input 
  data_in  = (PIND & 0xFC) | (PINB & 0x03);
  
  // Get TD20 data for 7.5 IPS or for the TD20AL (logging)
  data_out = td20_75[data_in];
  // Get TD20 data for 15 IPS
  // data_out = td20_15[data_in];
  // NB! Remember to comment out the one not used!
  
  // Write output
  PORTB = (data_out << 2) & 0x7C;
  PORTC = ((data_out & 0xF0) >> 4) & 0x0F;   
}
